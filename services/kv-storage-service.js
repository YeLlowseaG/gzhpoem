// Âä®ÊÄÅÂØºÂÖ• KVÔºåÈÅøÂÖçÁéØÂ¢ÉÂèòÈáèÁº∫Â§±Êó∂Êä•Èîô
let kv = null;
try {
    if (process.env.KV_REST_API_URL && process.env.KV_REST_API_TOKEN) {
        kv = require('@vercel/kv').kv;
    } else if (process.env.REDIS_URL) {
        // ‰ΩøÁî® Redis URL ÂàõÂª∫ËøûÊé•
        const redis = require('redis');
        kv = redis.createClient({ url: process.env.REDIS_URL });
        kv.connect().catch(console.error);
    }
} catch (error) {
    console.warn('KV/Redis ÂàùÂßãÂåñÂ§±Ë¥•:', error.message);
}
const { v4: uuidv4 } = require('uuid');

class KVStorageService {
    constructor() {
        this.isKVAvailable = this.checkKVAvailability();
        console.log(this.isKVAvailable ? '‚úÖ KV Â≠òÂÇ®ÊúçÂä°Â∑≤ÂêØÁî®' : '‚ö†Ô∏è KV Â≠òÂÇ®ÊúçÂä°‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®');
        
        // ÂÜÖÂ≠òÂ§áÁî®Â≠òÂÇ®ÔºàÂºÄÂèëÁéØÂ¢ÉÔºâ
        this.memoryStorage = {
            articles: [],
            stats: {
                totalArticles: 0,
                totalGenerations: 0,
                totalWechatUploads: 0,
                createdAt: new Date().toISOString()
            }
        };
    }

    /**
     * Ê£ÄÊü• KV ÊòØÂê¶ÂèØÁî®
     */
    checkKVAvailability() {
        return !!kv;
    }

    /**
     * Ê£ÄÊü•Â≠òÂÇ®ÊòØÂê¶ÂáÜÂ§áÂ∞±Áª™
     */
    isReady() {
        return true;
    }

    /**
     * Ëé∑ÂèñÊï∞ÊçÆÁõÆÂΩïË∑ØÂæÑÔºàÂÖºÂÆπÊÄßÔºâ
     */
    getDataPath() {
        return this.isKVAvailable ? 'Vercel KV' : 'Memory Storage';
    }

    /**
     * ‰øùÂ≠òÊñáÁ´†
     */
    async saveArticle(article) {
        try {
            const newArticle = {
                id: uuidv4(),
                ...article,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (this.isKVAvailable) {
                // ‰ΩøÁî® KV Â≠òÂÇ®
                const articles = await this.loadArticles();
                articles.unshift(newArticle);
                
                // ÈôêÂà∂ÊúÄÂ§ö‰øùÂ≠ò1000ÁØáÊñáÁ´†
                if (articles.length > 1000) {
                    articles.splice(1000);
                }
                
                await kv.set('articles', JSON.stringify(articles));
                
                // Êõ¥Êñ∞ÁªüËÆ°
                await this.updateStats('totalArticles', 1);
                await this.updateStats('totalGenerations', 1);
            } else {
                // ‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®
                this.memoryStorage.articles.unshift(newArticle);
                if (this.memoryStorage.articles.length > 1000) {
                    this.memoryStorage.articles.splice(1000);
                }
                this.memoryStorage.stats.totalArticles++;
                this.memoryStorage.stats.totalGenerations++;
            }

            console.log(`üìÑ ÊñáÁ´†‰øùÂ≠òÊàêÂäü: ${newArticle.metadata?.title || 'Êú™Áü•Ê†áÈ¢ò'}`);
            return newArticle;
            
        } catch (error) {
            console.error('‚ùå ‰øùÂ≠òÊñáÁ´†Â§±Ë¥•:', error);
            throw error;
        }
    }

    /**
     * Âä†ËΩΩÊâÄÊúâÊñáÁ´†
     */
    async loadArticles() {
        try {
            if (this.isKVAvailable) {
                const data = await kv.get('articles');
                if (data) {
                    return typeof data === 'string' ? JSON.parse(data) : data;
                }
                return [];
            } else {
                return this.memoryStorage.articles;
            }
        } catch (error) {
            console.error('‚ùå Âä†ËΩΩÊñáÁ´†Â§±Ë¥•:', error);
            return [];
        }
    }

    /**
     * Ëé∑ÂèñÊñáÁ´†ÂàóË°®
     */
    async getArticles({ page = 1, limit = 20, search = '' } = {}) {
        try {
            const articles = await this.loadArticles();
            
            // ÊêúÁ¥¢ËøáÊª§
            let filteredArticles = articles;
            if (search) {
                const searchLower = search.toLowerCase();
                filteredArticles = articles.filter(article => 
                    article.metadata?.title?.toLowerCase().includes(searchLower) ||
                    article.metadata?.author?.toLowerCase().includes(searchLower) ||
                    article.content?.toLowerCase().includes(searchLower)
                );
            }
            
            // ÂàÜÈ°µ
            const startIndex = (page - 1) * limit;
            const endIndex = startIndex + limit;
            const paginatedArticles = filteredArticles.slice(startIndex, endIndex);
            
            return {
                articles: paginatedArticles,
                pagination: {
                    current: page,
                    total: Math.ceil(filteredArticles.length / limit),
                    count: paginatedArticles.length,
                    totalCount: filteredArticles.length
                }
            };
            
        } catch (error) {
            console.error('‚ùå Ëé∑ÂèñÊñáÁ´†ÂàóË°®Â§±Ë¥•:', error);
            return {
                articles: [],
                pagination: { current: 1, total: 0, count: 0, totalCount: 0 }
            };
        }
    }

    /**
     * Ëé∑ÂèñÂçïÁØáÊñáÁ´†
     */
    async getArticle(id) {
        try {
            const articles = await this.loadArticles();
            const article = articles.find(a => a.id === id);
            
            if (!article) {
                throw new Error('ÊñáÁ´†‰∏çÂ≠òÂú®');
            }
            
            return article;
            
        } catch (error) {
            console.error('‚ùå Ëé∑ÂèñÊñáÁ´†Â§±Ë¥•:', error);
            throw error;
        }
    }

    /**
     * Êõ¥Êñ∞ÊñáÁ´†
     */
    async updateArticle(id, updates) {
        try {
            const articles = await this.loadArticles();
            const index = articles.findIndex(a => a.id === id);
            
            if (index === -1) {
                throw new Error('ÊñáÁ´†‰∏çÂ≠òÂú®');
            }
            
            articles[index] = {
                ...articles[index],
                ...updates,
                updatedAt: new Date().toISOString()
            };
            
            if (this.isKVAvailable) {
                await kv.set('articles', JSON.stringify(articles));
            } else {
                this.memoryStorage.articles = articles;
            }
            
            console.log(`üìÑ ÊñáÁ´†Êõ¥Êñ∞ÊàêÂäü: ${id}`);
            return articles[index];
            
        } catch (error) {
            console.error('‚ùå Êõ¥Êñ∞ÊñáÁ´†Â§±Ë¥•:', error);
            throw error;
        }
    }

    /**
     * Âà†Èô§ÊñáÁ´†
     */
    async deleteArticle(id) {
        try {
            const articles = await this.loadArticles();
            const index = articles.findIndex(a => a.id === id);
            
            if (index === -1) {
                throw new Error('ÊñáÁ´†‰∏çÂ≠òÂú®');
            }
            
            const deletedArticle = articles.splice(index, 1)[0];
            
            if (this.isKVAvailable) {
                await kv.set('articles', JSON.stringify(articles));
                await this.updateStats('totalArticles', -1);
            } else {
                this.memoryStorage.articles = articles;
                this.memoryStorage.stats.totalArticles--;
            }
            
            console.log(`üóëÔ∏è ÊñáÁ´†Âà†Èô§ÊàêÂäü: ${deletedArticle.metadata?.title || 'Êú™Áü•Ê†áÈ¢ò'}`);
            return deletedArticle;
            
        } catch (error) {
            console.error('‚ùå Âà†Èô§ÊñáÁ´†Â§±Ë¥•:', error);
            throw error;
        }
    }

    /**
     * ÊêúÁ¥¢ÊñáÁ´†
     */
    async searchArticles(query, { page = 1, limit = 20 } = {}) {
        return this.getArticles({ page, limit, search: query });
    }

    /**
     * Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØ
     */
    async getStats() {
        try {
            let stats;
            
            if (this.isKVAvailable) {
                const data = await kv.get('stats');
                if (data) {
                    stats = typeof data === 'string' ? JSON.parse(data) : data;
                } else {
                    stats = {
                        totalArticles: 0,
                        totalGenerations: 0,
                        totalWechatUploads: 0,
                        createdAt: new Date().toISOString()
                    };
                }
            } else {
                stats = this.memoryStorage.stats;
            }
            
            // Ëé∑ÂèñÂÆûÊó∂ÁªüËÆ°
            const articles = await this.loadArticles();
            const recentArticles = articles.filter(a => 
                new Date(a.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            );
            
            return {
                ...stats,
                currentArticles: articles.length,
                recentArticles: recentArticles.length,
                updatedAt: new Date().toISOString(),
                storageType: this.isKVAvailable ? 'Vercel KV' : 'Memory'
            };
            
        } catch (error) {
            console.error('‚ùå Ëé∑ÂèñÁªüËÆ°Â§±Ë¥•:', error);
            return {
                totalArticles: 0,
                totalGenerations: 0,
                totalWechatUploads: 0,
                currentArticles: 0,
                recentArticles: 0,
                storageType: 'Error'
            };
        }
    }

    /**
     * Êõ¥Êñ∞ÁªüËÆ°
     */
    async updateStats(key, increment) {
        try {
            if (this.isKVAvailable) {
                const data = await kv.get('stats');
                const stats = data ? (typeof data === 'string' ? JSON.parse(data) : data) : {};
                stats[key] = (stats[key] || 0) + increment;
                stats.updatedAt = new Date().toISOString();
                await kv.set('stats', JSON.stringify(stats));
            } else {
                this.memoryStorage.stats[key] = (this.memoryStorage.stats[key] || 0) + increment;
                this.memoryStorage.stats.updatedAt = new Date().toISOString();
            }
            
        } catch (error) {
            console.error('‚ùå Êõ¥Êñ∞ÁªüËÆ°Â§±Ë¥•:', error);
        }
    }

    /**
     * Ê†áËÆ∞ÊñáÁ´†‰∏∫Â∑≤‰∏ä‰º†ÂæÆ‰ø°
     */
    async markAsUploaded(id, uploadData) {
        try {
            await this.updateArticle(id, {
                wechatUpload: {
                    uploaded: true,
                    uploadedAt: new Date().toISOString(),
                    ...uploadData
                }
            });
            
            // Êõ¥Êñ∞ÁªüËÆ°
            await this.updateStats('totalWechatUploads', 1);
            
        } catch (error) {
            console.error('‚ùå Ê†áËÆ∞‰∏ä‰º†Áä∂ÊÄÅÂ§±Ë¥•:', error);
        }
    }

    /**
     * ÂØºÂá∫Êï∞ÊçÆ
     */
    async exportData() {
        try {
            const articles = await this.loadArticles();
            const stats = await this.getStats();
            
            return {
                articles,
                stats,
                exportedAt: new Date().toISOString(),
                storageType: this.isKVAvailable ? 'Vercel KV' : 'Memory'
            };
            
        } catch (error) {
            console.error('‚ùå ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
            throw error;
        }
    }

    /**
     * ÂØºÂÖ•Êï∞ÊçÆ
     */
    async importData(data) {
        try {
            if (data.articles && Array.isArray(data.articles)) {
                if (this.isKVAvailable) {
                    await kv.set('articles', JSON.stringify(data.articles));
                } else {
                    this.memoryStorage.articles = data.articles;
                }
            }
            
            if (data.stats) {
                if (this.isKVAvailable) {
                    await kv.set('stats', JSON.stringify(data.stats));
                } else {
                    this.memoryStorage.stats = data.stats;
                }
            }
            
            console.log('‚úÖ Êï∞ÊçÆÂØºÂÖ•ÊàêÂäü');
            
        } catch (error) {
            console.error('‚ùå ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•:', error);
            throw error;
        }
    }

    /**
     * Ê∏ÖÁêÜÊóßÊï∞ÊçÆ
     */
    async cleanup(daysToKeep = 90) {
        try {
            const articles = await this.loadArticles();
            const cutoffDate = new Date(Date.now() - daysToKeep * 24 * 60 * 60 * 1000);
            
            const filteredArticles = articles.filter(article => 
                new Date(article.createdAt) > cutoffDate
            );
            
            if (filteredArticles.length < articles.length) {
                if (this.isKVAvailable) {
                    await kv.set('articles', JSON.stringify(filteredArticles));
                } else {
                    this.memoryStorage.articles = filteredArticles;
                }
                console.log(`üßπ Ê∏ÖÁêÜ‰∫Ü ${articles.length - filteredArticles.length} ÁØáÊóßÊñáÁ´†`);
            }
            
        } catch (error) {
            console.error('‚ùå Ê∏ÖÁêÜÊï∞ÊçÆÂ§±Ë¥•:', error);
        }
    }

    /**
     * ËøÅÁßªÁé∞ÊúâÊï∞ÊçÆÂà∞ KVÔºà‰∏ÄÊ¨°ÊÄßÊìç‰ΩúÔºâ
     */
    async migrateFromFileSystem(oldStorageService) {
        try {
            if (!this.isKVAvailable) {
                console.log('‚ö†Ô∏è KV ‰∏çÂèØÁî®ÔºåË∑≥ËøáËøÅÁßª');
                return;
            }

            console.log('üîÑ ÂºÄÂßãËøÅÁßªÊï∞ÊçÆÂà∞ KV...');
            
            // ËøÅÁßªÊñáÁ´†
            const articles = await oldStorageService.loadArticles();
            if (articles.length > 0) {
                await kv.set('articles', JSON.stringify(articles));
                console.log(`‚úÖ ËøÅÁßª‰∫Ü ${articles.length} ÁØáÊñáÁ´†`);
            }
            
            // ËøÅÁßªÁªüËÆ°
            const stats = await oldStorageService.getStats();
            await kv.set('stats', JSON.stringify(stats));
            console.log('‚úÖ ËøÅÁßª‰∫ÜÁªüËÆ°Êï∞ÊçÆ');
            
            console.log('üéâ Êï∞ÊçÆËøÅÁßªÂÆåÊàê');
            
        } catch (error) {
            console.error('‚ùå Êï∞ÊçÆËøÅÁßªÂ§±Ë¥•:', error);
        }
    }
}

module.exports = KVStorageService;